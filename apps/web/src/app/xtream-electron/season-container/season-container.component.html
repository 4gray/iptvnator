<section class="seasons-section">
    <div class="section-header">
        <div class="section-header__left">
            <h3 class="section-title">Seasons and Episodes</h3>
            @if (selectedSeason) {
                <button class="back-btn" (click)="selectedSeason = undefined">
                    <mat-icon>arrow_back</mat-icon>
                    <span>Back to seasons</span>
                </button>
            }
        </div>
        @if (selectedSeason) {
            <div class="view-toggle">
                <mat-button-toggle-group
                    [value]="viewMode()"
                    (change)="setViewMode($event.value)"
                    hideSingleSelectionIndicator
                >
                    <mat-button-toggle value="grid" [matTooltip]="'Grid view'">
                        <mat-icon>grid_view</mat-icon>
                    </mat-button-toggle>
                    <mat-button-toggle value="list" [matTooltip]="'List view'">
                        <mat-icon>view_list</mat-icon>
                    </mat-button-toggle>
                </mat-button-toggle-group>
            </div>
        }
    </div>

    <div class="content-container">
        @if (isLoading()) {
            <div class="loading-container">
                <mat-spinner diameter="40"></mat-spinner>
            </div>
        } @else if (!selectedSeason) {
            <!-- Seasons Grid -->
            <div class="seasons-grid">
                @for (
                    season of seasons() | keyvalue: compareSeasons;
                    track $index
                ) {
                    <button
                        class="season-card"
                        (click)="selectSeason(season.key)"
                        [class.season-card--has-episodes]="season.value?.length"
                    >
                        <div class="season-card__number">{{ season.key }}</div>
                        <div class="season-card__label">Season</div>
                        @if (season.value?.length) {
                            <div class="season-card__episodes">
                                {{ season.value.length }}
                                {{
                                    season.value.length === 1
                                        ? 'Episode'
                                        : 'Episodes'
                                }}
                            </div>
                        }
                        <div class="season-card__arrow">
                            <mat-icon>chevron_right</mat-icon>
                        </div>
                    </button>
                }
            </div>
        } @else {
            @if (viewMode() === 'grid') {
                <!-- Episodes Grid View -->
                <div class="episodes-grid">
                    @for (episode of seasons()[selectedSeason]; track $index) {
                        @let episodeInfo = getEpisodeInfo(episode);
                        <article
                            class="episode-card"
                            (click)="selectEpisode(episode)"
                            [class.episode-card--watched]="
                                isEpisodeWatched(episode)
                            "
                            [class.episode-card--in-progress]="
                                isEpisodeInProgress(episode)
                            "
                        >
                            <div class="episode-card__thumbnail">
                                @if (episodeInfo?.movie_image) {
                                    <img
                                        [src]="episodeInfo.movie_image"
                                        (error)="
                                            $event.target.src =
                                                './assets/images/default-episode.png'
                                        "
                                        alt="Episode thumbnail"
                                        loading="lazy"
                                    />
                                } @else {
                                    <div class="episode-card__placeholder">
                                        <mat-icon>play_circle_outline</mat-icon>
                                    </div>
                                }
                                @if (getEpisodeProgress(episode) > 0) {
                                    <app-progress-capsule
                                        [progress]="getEpisodeProgress(episode)"
                                    />
                                    @if (getEpisodePositionText(episode); as time) {
                                        <div class="episode-card__position-text">
                                            {{ time }}
                                        </div>
                                    }
                                }
                                <app-watched-badge
                                    [isWatched]="isEpisodeWatched(episode)"
                                />
                                <div class="episode-card__actions">
                                    @if (isElectron()) {
                                        @if (isEpisodeDownloaded(episode)) {
                                            <button
                                                mat-icon-button
                                                class="download-btn download-btn--completed"
                                                (click)="playFromLocal($event, episode)"
                                                [matTooltip]="'DOWNLOADS.PLAY_LOCAL' | translate"
                                            >
                                                <mat-icon>play_circle</mat-icon>
                                            </button>
                                        } @else if (isEpisodeDownloading(episode)) {
                                            <button
                                                mat-icon-button
                                                class="download-btn download-btn--downloading"
                                                disabled
                                                [matTooltip]="'DOWNLOADS.STATUS.DOWNLOADING' | translate"
                                            >
                                                <mat-icon>downloading</mat-icon>
                                            </button>
                                        } @else {
                                            <button
                                                mat-icon-button
                                                class="download-btn"
                                                (click)="downloadEpisode($event, episode)"
                                                [matTooltip]="'DOWNLOADS.DOWNLOAD' | translate"
                                            >
                                                <mat-icon>download</mat-icon>
                                            </button>
                                        }
                                    }
                                    <button
                                        mat-icon-button
                                        class="toggle-watched-btn"
                                        (click)="toggleWatched($event, episode)"
                                        [matTooltip]="
                                            (isEpisodeWatched(episode)
                                                ? 'XTREAM.MARK_UNWATCHED'
                                                : 'XTREAM.MARK_WATCHED') | translate
                                        "
                                    >
                                        <mat-icon>{{
                                            isEpisodeWatched(episode)
                                                ? 'check_circle'
                                                : 'radio_button_unchecked'
                                        }}</mat-icon>
                                    </button>
                                </div>
                                <div class="episode-card__overlay">
                                    <div class="episode-card__play">
                                        <mat-icon>play_arrow</mat-icon>
                                    </div>
                                </div>
                                <div class="episode-card__number">
                                    {{ episode.episode_num }}
                                </div>
                            </div>
                            <div class="episode-card__info">
                                <h4 class="episode-card__title">
                                    {{ episode.episode_num }}. {{ episode.title }}
                                </h4>
                                @if (episodeInfo?.plot) {
                                    <p class="episode-card__plot">
                                        {{ episodeInfo.plot }}
                                    </p>
                                }
                                @if (episodeInfo?.duration) {
                                    <span class="episode-card__duration">
                                        {{ episodeInfo.duration }}
                                    </span>
                                }
                            </div>
                        </article>
                    }
                </div>
            } @else {
                <!-- Episodes List View -->
                <div class="episodes-list">
                    @for (episode of seasons()[selectedSeason]; track $index) {
                        @let episodeInfo = getEpisodeInfo(episode);
                        <article
                            class="episode-list-item"
                            (click)="selectEpisode(episode)"
                            [class.episode-list-item--watched]="isEpisodeWatched(episode)"
                            [class.episode-list-item--in-progress]="isEpisodeInProgress(episode)"
                        >
                            <div class="episode-list-item__number">
                                {{ episode.episode_num }}
                            </div>
                            <div class="episode-list-item__content">
                                <div class="episode-list-item__header">
                                    <h4 class="episode-list-item__title">
                                        {{ episode.title }}
                                        @if (isEpisodeWatched(episode)) {
                                            <mat-icon class="watched-icon">check_circle</mat-icon>
                                        }
                                    </h4>
                                    <div class="episode-list-item__meta">
                                        @if (episodeInfo?.duration) {
                                            <span class="episode-list-item__duration">
                                                {{ episodeInfo.duration }}
                                            </span>
                                        }
                                        @if (getEpisodePositionText(episode); as time) {
                                            <span class="episode-list-item__progress-text">
                                                {{ time }}
                                            </span>
                                        }
                                    </div>
                                </div>
                                @if (episodeInfo?.plot) {
                                    <p class="episode-list-item__description">
                                        {{ episodeInfo.plot }}
                                    </p>
                                }
                                @if (getEpisodeProgress(episode) > 0) {
                                    <div class="episode-list-item__progress-bar">
                                        <div
                                            class="episode-list-item__progress-fill"
                                            [style.width.%]="getEpisodeProgress(episode)"
                                        ></div>
                                    </div>
                                }
                            </div>
                            <div class="episode-list-item__actions">
                                <button
                                    mat-icon-button
                                    class="action-btn play-btn"
                                    (click)="selectEpisode(episode); $event.stopPropagation()"
                                    [matTooltip]="'Play'"
                                >
                                    <mat-icon>play_arrow</mat-icon>
                                </button>
                                @if (isElectron()) {
                                    @if (isEpisodeDownloaded(episode)) {
                                        <button
                                            mat-icon-button
                                            class="action-btn action-btn--success"
                                            (click)="playFromLocal($event, episode)"
                                            [matTooltip]="'DOWNLOADS.PLAY_LOCAL' | translate"
                                        >
                                            <mat-icon>folder_open</mat-icon>
                                        </button>
                                    } @else if (isEpisodeDownloading(episode)) {
                                        <button
                                            mat-icon-button
                                            class="action-btn"
                                            disabled
                                            [matTooltip]="'DOWNLOADS.STATUS.DOWNLOADING' | translate"
                                        >
                                            <mat-icon>downloading</mat-icon>
                                        </button>
                                    } @else {
                                        <button
                                            mat-icon-button
                                            class="action-btn"
                                            (click)="downloadEpisode($event, episode)"
                                            [matTooltip]="'DOWNLOADS.DOWNLOAD' | translate"
                                        >
                                            <mat-icon>download</mat-icon>
                                        </button>
                                    }
                                }
                                <button
                                    mat-icon-button
                                    class="action-btn"
                                    (click)="toggleWatched($event, episode)"
                                    [matTooltip]="
                                        (isEpisodeWatched(episode)
                                            ? 'XTREAM.MARK_UNWATCHED'
                                            : 'XTREAM.MARK_WATCHED') | translate
                                    "
                                    [class.action-btn--success]="isEpisodeWatched(episode)"
                                >
                                    <mat-icon>{{
                                        isEpisodeWatched(episode)
                                            ? 'check_circle'
                                            : 'radio_button_unchecked'
                                    }}</mat-icon>
                                </button>
                            </div>
                        </article>
                    }
                </div>
            }
        }
    </div>
</section>
